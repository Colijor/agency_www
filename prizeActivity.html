<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>奖品活动设置</title>
    <!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
    <!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 -->
    <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->
    <!-- BOOTSTRAP STYLES-->
    <link href="assets/css/bootstrap.css" rel="stylesheet" />
    <!-- FONTAWESOME STYLES-->
    <link href="assets/css/font-awesome.css" rel="stylesheet" />
    <!--CUSTOM BASIC STYLES-->
    <link href="assets/css/basic.css" rel="stylesheet" />
    <!--CUSTOM MAIN STYLES-->
    <link href="assets/css/custom.css" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/reset.css" />
    <!-- <link rel="stylesheet" href="assets/css/pagination.css" /> -->
    <link rel="stylesheet" href="assets/css/jquery.sPage.css" />
    <link rel="stylesheet" href="assets/css/index.css" />
</head>

<body>
    <!-- /. NAV SIDE  -->
    <div id="page-wrapper">
        <div class="pageTitle">
            <span>奖品活动设置</span>
        </div>
        <div id="page-inner">
            <div class="row">
                <div class="col-md-10"></div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModalDialog"
                        data-type="addActivity">
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> 新增
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                        </div>
                        <div class="panel-body">
                            <div class="table-responsive">
                                <table id="activityTable" class="table table-striped table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>序号</th>
                                            <th>活动名称</th>
                                            <th>利润率抽成</th>
                                            <th>每人抽奖次数</th>
                                            <th>每次抽奖时间间隔</th>
                                            <th>是否促销</th>
                                            <th>抽奖模式</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <span class="page-inner-tip">暂无数据</span>
        </div>
        <!-- /. PAGE INNER  -->
    </div>
    <!-- /. PAGE WRAPPER  -->
    <!-- </div> -->
    <!-- /. WRAPPER  -->
    <!-- /. myModalDialog -->
    <div class="modal fade" id="myModalDialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
        aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="exampleModalLabel">新增活动</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" id="addform">
                        <div class="form-group">
                            <label for="recipient-name" class="control-label col-sm-4">活动名称&nbsp;&nbsp;</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" name="activeName" id="activeName">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="recipient-name" class="control-label col-sm-4">利润率抽成%&nbsp;&nbsp;</label>
                            <div class="col-sm-8">
                                <input type="number" name="returnRate" id="returnRate" class="form-control" value="0"
                                    onblur="checkNumb(1,'returnRate');"
                                    onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^0-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"
                                    onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^0-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="recipient-name" class="control-label col-sm-4">每人抽奖次数&nbsp;&nbsp;</label>
                            <div class="col-sm-8">
                                <input type="number" name="peopleWonPrizePerDay" id="peopleWonPrizePerDay"
                                    class="form-control" value="0" onblur="checkNumb(2,'peopleWonPrizePerDay');"
                                    onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^0-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"
                                    onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^0-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="recipient-name" class="control-label col-sm-4">每次抽奖时间间隔秒&nbsp;&nbsp;</label>
                            <div class="col-sm-8">
                                <input type="number" name="freeTimes" id="freeTimes" class="form-control" value="0"
                                    onblur="checkNumb(2,'freeTimes');"
                                    onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^0-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"
                                    onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^0-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="recipient-name" class="control-label col-sm-4">是否促销模式&nbsp;&nbsp;</label>
                            <div class="col-sm-8">
                                <select name="isPromote" id="isPromote" class="form-control">
                                    <option value="0" selected>否</option>
                                    <option value="1">是</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="recipient-name" class="control-label col-sm-4">抽奖模式&nbsp;&nbsp;</label>
                            <div class="col-sm-8">
                                <select name="pattern" id="pattern" class="form-control">
                                    <option value="0" selected>游戏模式</option>
                                    <option value="1">免费模式</option>
                                    <option value="2">收费模式</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitActivity()">确定</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="myModalDialog2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
        aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="exampleModalLabel">编辑活动</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" id="updateform">
                        <div class="form-group">
                            <label for="recipient-name" class="control-label col-sm-4">活动名称&nbsp;&nbsp;</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" name="activeName2" id="activeName2">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="recipient-name" class="control-label col-sm-4">利润率抽成%&nbsp;&nbsp;</label>
                            <div class="col-sm-8">
                                <input type="number" name="returnRate2" id="returnRate2" class="form-control" value="0"
                                    onblur="checkNumb(1,'returnRate');"
                                    onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^0-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"
                                    onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^0-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="recipient-name" class="control-label col-sm-4">每人抽奖次数&nbsp;&nbsp;</label>
                            <div class="col-sm-8">
                                <input type="number" name="peopleWonPrizePerDay2" id="peopleWonPrizePerDay2"
                                    class="form-control" value="0" onblur="checkNumb(2,'peopleWonPrizePerDay');"
                                    onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^0-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"
                                    onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^0-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="recipient-name" class="control-label col-sm-4">每次抽奖时间间隔秒&nbsp;&nbsp;</label>
                            <div class="col-sm-8">
                                <input type="number" name="freeTimes2" id="freeTimes2" class="form-control" value="0"
                                    onblur="checkNumb(2,'freeTimes');"
                                    onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^0-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"
                                    onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^0-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="recipient-name" class="control-label col-sm-4">是否促销模式&nbsp;&nbsp;</label>
                            <div class="col-sm-8">
                                <select name="isPromote2" id="isPromote2" class="form-control">
                                    <option value="0" selected>否</option>
                                    <option value="1">是</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="recipient-name" class="control-label col-sm-4">抽奖模式&nbsp;&nbsp;</label>
                            <div class="col-sm-8">
                                <select name="pattern2" id="pattern2" class="form-control">
                                    <option value="0" selected>游戏模式</option>
                                    <option value="1">免费模式</option>
                                    <option value="2">收费模式</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitActivity2()">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 警告提示模态框 -->
    <div class="modal fade bs-example-modal-sm" id="wangModal" aria-hidden="true" data-backdrop="static"
        data-keyboard="false">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>提示</h3>
                </div>
                <div class="modal-body">
                    <p class="tipText">确定要关闭警告框信息？</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-info" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <!-- SCRIPTS -AT THE BOTOM TO REDUCE THE LOAD TIME-->
    <!-- JQUERY SCRIPTS -->
    <script src="assets/js/jquery-3.3.1.min.js"></script>
    <script src="assets/js/cframe.js"></script>
    <!-- BOOTSTRAP SCRIPTS -->
    <script src="assets/js/bootstrap.js"></script>
    <!-- METISMENU SCRIPTS -->
    <script src="assets/js/jquery.metisMenu.js"></script>
    <script src="assets/js/jquery.cookie.js"></script>
    <!-- CUSTOM SCRIPTS -->
    <script src="assets/js/custom.js"></script>
    <script src="assets/js/jquery.sPage.js"></script>
    <script src="assets/js/commont.js"></script>
    <script type="text/javascript">
        let type = '';
        let id = '';
        let configurationId = '';

        var serverIp_ = localStorage.getItem('serverIp');
        var token = localStorage.getItem('token');
        var agencyId = localStorage.getItem('agencyId');
        // var token = $.cookie('token');
        // var agencyId = $.cookie('agencyId');
        getActivity();

        function getActivity() {
            $.ajax({
                headers: {
                    "token": token
                },
                type: "get",
                url: serverIp_ + "/agency/good/configuration/get/" + agencyId,
                data: '',
                contentType: 'application/json;charset=UTF-8',
                dataType: "json",
                success: function (data) {
                    console.log("活动配置列表：");
                    if (data.code == 0) {
                        let orders = data.data;
                        console.log(orders);
                        if (orders.length > 0) {
                            $('.page-inner-tip').css('display', 'none');
                            $('#activityTable tbody').empty();
                            for (let i = 0; i < orders.length; i++) {
                                $('#activityTable tbody').append(`
                            <tr>
                                <td>${i+1}</td>
                                <td>${orders[i].name}</td>
                                <td>${orders[i].returnRate}%</td>
                                <td>${orders[i].peopleWonPrizePerDay}</td>
                                <td>${orders[i].freeTimes}s</td>
                                <td>${orders[i].isPromote == 0 ? '否':'是'}</td>
                                <td>${orders[i].pattern == 0 ? '游戏模式' : orders[i].pattern == 1 ? '免费模式' : '收费模式'}</td>
                                <td>
                                    <button type="button" class="btn btn-info" id="Configuration" onclick="gotoConfiguration(${orders[i].id})">配置奖品</button>
                                    <button type="button" class="btn btn-info" id="Configuration" onclick="gotobindScrennCode(${orders[i].id})">绑定盒子</button>
                                    <button type="button" class="btn btn-info" data-id="${orders[i].id}" data-type="updateActivity" data-toggle="modal" data-target="#myModalDialog2">编辑</button>
                                    <button type="button" class="btn btn-danger" id="dltActivity${orders[i].id}">删除</button>
                                </td>
                            </tr>`);
                            }
                        }
                    }
                }
            });
        }

        function submitActivity() {
            var d = {};
            var t = $('#addform').serializeArray();
            $.each(t, function () {
                d[this.name] = this.value;
            });
            console.log(d);
            for (let key in d) {
                if (key == "activeName" && d[key] == '') {
                    $('.tipText').text("请输入活动名称");
                    $('#wangModal').modal('show');
                    return;
                } else if (key == "returnRate" && d[key] == '') {
                    $('.tipText').text("请输入利润率抽成%");
                    $('#wangModal').modal('show');
                    return;
                } else if (key == "peopleWonPrizePerDay" && d[key] == '') {
                    $('.tipText').text("请输入每人抽奖次数");
                    $('#wangModal').modal('show');
                    return;
                } else if (key == "freeTimes" && d[key] == '') {
                    $('.tipText').text("请输入每次抽奖时间间隔秒");
                    $('#wangModal').modal('show');
                    return;
                } else if (key == "isPromote" && d[key] == '') {
                    $('.tipText').text("请选择是否促销模式");
                    $('#wangModal').modal('show');
                    return;
                } else if (key == "pattern" && d[key] == '') {
                    $('.tipText').text("请选择抽奖模式");
                    $('#wangModal').modal('show');
                    return;
                }
            }
            if (type == "addActivity") {
                $.ajax({
                    headers: {
                        "token": token
                    },
                    type: "post",
                    url: serverIp_ + "/agency/good/configuration/add",
                    data: JSON.stringify({
                        "businessId": agencyId,
                        "name": d.activeName,
                        "returnRate": d.returnRate,
                        "peopleWonPrizePerDay": d.peopleWonPrizePerDay,
                        "freeTimes": d.freeTimes,
                        "isPromote": d.isPromote,
                        "pattern": d.pattern
                    }),
                    contentType: 'application/json;charset=UTF-8',
                    dataType: "json",
                    success: function (res) {
                        console.log("添加活动");
                        console.log(res.data);
                        if (res.code === 0) {
                            configurationId = res.data;
                            $('#myModalDialog').modal('hide');
                            getActivity();
                        } else {
                            $('.tipText').text(res.message);
                            $('#wangModal').modal('show');
                        }
                    }
                });
            }
        }

        function submitActivity2() {
            var d = {};
            var t = $('#updateform').serializeArray();
            $.each(t, function () {
                d[this.name] = this.value;
            });
            console.log(d);
            for (let key in d) {
                if (key == "activeName2" && d[key] == '') {
                    $('.tipText').text("请输入活动名称");
                    $('#wangModal').modal('show');
                    return;
                } else if (key == "returnRate2" && d[key] == '') {
                    $('.tipText').text("请输入利润率抽成%");
                    $('#wangModal').modal('show');
                    return;
                } else if (key == "peopleWonPrizePerDay2" && d[key] == '') {
                    $('.tipText').text("请输入每人抽奖次数");
                    $('#wangModal').modal('show');
                    return;
                } else if (key == "freeTimes2" && d[key] == '') {
                    $('.tipText').text("请输入每次抽奖时间间隔秒");
                    $('#wangModal').modal('show');
                    return;
                } else if (key == "isPromote2" && d[key] == '') {
                    $('.tipText').text("请选择是否促销模式");
                    $('#wangModal').modal('show');
                    return;
                } else if (key == "pattern2" && d[key] == '') {
                    $('.tipText').text("请选择抽奖模式");
                    $('#wangModal').modal('show');
                    return;
                }
            }
            if (type == "updateActivity") {
                $.ajax({
                    headers: {
                        "token": token
                    },
                    type: "post",
                    url: serverIp_ + "/agency/good/configuration/update",
                    data: JSON.stringify({
                        "id": id,
                        "businessId": agencyId,
                        "name": d.activeName2,
                        "returnRate": d.returnRate2,
                        "peopleWonPrizePerDay": d.peopleWonPrizePerDay2,
                        "freeTimes": d.freeTimes2,
                        "isPromote": d.isPromote2,
                        "pattern": d.pattern2
                    }),
                    contentType: 'application/json;charset=UTF-8',
                    dataType: "json",
                    success: function (res) {
                        if (res.code === 0) {
                            $('#myModalDialog2').modal('hide');
                            getActivity();
                        } else {
                            $('.tipText').text(res.message);
                            $('#wangModal').modal('show');
                        }
                    }
                });
            }
        }

        // 配置奖品
        function gotoConfiguration(id) {
            window.location.href = "prizeManage.html?configurationId=" + id;
        }
        // 绑定屏幕码
        function gotobindScrennCode(id) {
            window.location.href = "bindScreenCode.html?configurationId=" + id;
        }

        // 删除
        $('#activityTable tbody').on('click', 'button', function (e) {
            var str = e.target.id;
            var idName = str.slice(0, 11);
            var ID = str.slice(11);
            if (idName == "dltActivity") {
                //删除
                $.ajax({
                    headers: {
                        "token": token
                    },
                    type: "delete",
                    url: serverIp_ + "/agency/good/configuration/delete/" + ID,
                    data: '',
                    contentType: 'application/json;charset=UTF-8',
                    dataType: "json",
                    success: function (data) {
                        console.log("删除成功");
                        getActivity();
                    }
                });
            }
        })

        // 查询单个活动
        function findActivity(id) {
            $.ajax({
                headers: {
                    "token": token
                },
                type: "get",
                url: serverIp_ + "/agency/good/configuration/get/singleton/" + id,
                data: "",
                contentType: 'application/json;charset=UTF-8',
                dataType: "json",
                success: function (data) {
                    console.log("单个");
                    console.log(data.data);
                    $('#activeName2').val(data.data.name);
                    $('#returnRate2').val(data.data.returnRate);
                    $('#peopleWonPrizePerDay2').val(data.data.peopleWonPrizePerDay);
                    $('#freeTimes2').val(data.data.freeTimes);
                    $('#isPromote2').val(data.data.isPromote);
                    $('#pattern2').val(data.data.pattern);
                }
            });
        }
        // 添加活动模态框
        $('#myModalDialog').on('show.bs.modal', function (e) {
            var zIndex = Number($('.modal').css('z-index'));
            $('#myModalDialog').css("zIndex", zIndex + 1);
            type = $(e.relatedTarget).data("type");
            if (type == "addActivity") {
                $('#activeName').val('');
                $('#returnRate').val('');
                $('#peopleWonPrizePerDay').val('');
                $('#freeTimes').val('');
                $('#isPromote').val('0');
                $('#pattern').val('0');
            }
        });

        // 编辑活动模态框
        $('#myModalDialog2').on('show.bs.modal', function (e) {
            var zIndex = Number($('.modal').css('z-index'));
            $('#myModalDialog2').css("zIndex", zIndex + 1);
            type = $(e.relatedTarget).data("type");
            if (type == "updateActivity") {
                id = $(e.relatedTarget).data("id");
                console.log('id:' + id);
                findActivity(id);
            }
        });


        // 模态框居中
        ModalDialog('myModalDialog');
        ModalDialog('myModalDialog2');
        ModalDialog('wangModal');

        // 提示模态框
        $('#wangModal').on('shown.bs.modal', function (e) {
            var zIndex = Number($('.modal').css('z-index'));
            $('#wangModal').css("zIndex", zIndex + 1);
        });
    </script>
</body>

</html>