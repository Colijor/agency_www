<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>添加奖品</title>
    <!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
    <!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 -->
    <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->
    <!-- BOOTSTRAP STYLES-->
    <link href="assets/css/bootstrap.css" rel="stylesheet" />
    <!-- FONTAWESOME STYLES-->
    <link href="assets/css/font-awesome.css" rel="stylesheet" />
    <!--CUSTOM BASIC STYLES-->
    <link href="assets/css/basic.css" rel="stylesheet" />
    <!--CUSTOM MAIN STYLES-->
    <link href="assets/css/custom.css" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/reset.css" />
    <!-- <link rel="stylesheet" href="assets/css/pagination.css" /> -->
    <link rel="stylesheet" href="assets/css/jquery.sPage.css" />
    <link rel="stylesheet" href="assets/css/index.css" />
</head>

<body>
    <!-- /. NAV SIDE  -->
    <div id="page-wrapper">
        <div>
            <span class="back"><img src="images/back.png" width="18">返回</span>
        </div>
        <div class="pageTitle">
            <span>奖品管理/添加奖品</span>
        </div>
        <div id="page-inner">
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <div class="alert-left">
                                <form class="form-horizontal" id="addform">
                                    <div class="form-group">
                                        <label for="recipient-name"
                                            class="control-label col-sm-4">奖品名称&nbsp;&nbsp;</label>
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control" name="prizeName" id="prizeName">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="recipient-name"
                                            class="control-label col-sm-4">中奖概率&nbsp;&nbsp;</label>
                                        <div class="col-sm-8">
                                            <input type="number" class="form-control" name="probability"
                                                id="probability" onblur="checkNumb(1,'probability');"
                                                onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^0-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"
                                                onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^0-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="recipient-name"
                                            class="control-label col-sm-4">奖品价值&nbsp;&nbsp;</label>
                                        <div class="col-sm-8">
                                            <input type="number" class="form-control" name="price" id="price"
                                                onblur="checkNumb(2,'price')"
                                                onkeyup="this.value= this.value.match(/\d+(\.\d{0,2})?/) ? this.value.match(/\d+(\.\d{0,2})?/)[0] : ''"
                                                onafterpaste="this.value= this.value.match(/\d+(\.\d{0,2})?/) ? this.value.match(/\d+(\.\d{0,2})?/)[0] : ''">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="recipient-name"
                                            class="control-label col-sm-4">奖品数量&nbsp;&nbsp;</label>
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control" name="amount" id="amount">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="recipient-name"
                                            class="control-label col-sm-4">发券模式&nbsp;&nbsp;</label>
                                        <div class="col-sm-8">
                                            <select class="form-control" name="fqMode" id="fqMode"
                                                onchange="changefqMode('fqMode')">
                                                <option value=0 selected>商家优惠券</option>
                                                <option value=1>app下载</option>
                                                <option value=2>淘宝优惠券</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group secretWords" style="display: none;">
                                        <label for="recipient-name"
                                            class="control-label col-sm-4">奖品链接&nbsp;&nbsp;</label>
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control" name="prizeLink" id="prizeLink"
                                                placeholder="奖品链接复制粘贴到这里">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="recipient-name"
                                            class="control-label col-sm-4">奖品说明&nbsp;&nbsp;</label>
                                        <div class="col-sm-8">
                                            <textarea class="form-control" id="description" name="description"
                                                placeholder="用于中奖后的描述" rows="3" cols="40" maxlength="100"></textarea>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="alert-right">
                                <form id="prizeform" enctype="multipart/form-data">
                                    <div id="imgPreview">
                                        <div id="prompt3">
                                            <div id="imgSpan">
                                                <img src="" id="img3" />
                                                <img src="images/upload.jpg" class="img2" />
                                            </div>
                                            <input type="file" id="file" class="filepath" onchange="uploadPrize(this)"
                                                accept="image/jpg,image/jpeg,image/png,image/PNG">
                                        </div>
                                    </div>
                                    <div><span>点击上传预览图片</span></div>
                                </form>
                            </div>
                            <div class="alert-right">
                                <div class="upload-pic">
                                    <label class="up-lab" for="add-pic-btn">上传海报</label>
                                    <input type="file" accept="image/*" multiple class="up-file" id="add-pic-btn">
                                </div>
                                <div class="group-coms-pic" id="groupTu">
                                </div>
                            </div>
                            <div class="alert-right">
                                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" onclick="submitPrize()">确定</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /. PAGE INNER  -->
    </div>
    <!-- /. PAGE WRAPPER  -->
    <!-- </div> -->
    <!-- /. WRAPPER  -->

    <!-- 警告提示模态框 -->
    <div class="modal fade bs-example-modal-sm" id="wangModal" aria-hidden="true" data-backdrop="static"
        data-keyboard="false">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>提示</h3>
                </div>
                <div class="modal-body">
                    <p class="tipText">确定要关闭警告框信息？</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-info" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <!-- SCRIPTS -AT THE BOTOM TO REDUCE THE LOAD TIME-->
    <!-- JQUERY SCRIPTS -->
    <script src="assets/js/jquery-3.3.1.min.js"></script>
    <!-- BOOTSTRAP SCRIPTS -->
    <script src="assets/js/bootstrap.js"></script>
    <script src="assets/js/jquery.cookie.js"></script>
    <!-- METISMENU SCRIPTS -->
    <script src="assets/js/jquery.metisMenu.js"></script>
    <!-- CUSTOM SCRIPTS -->
    <script src="assets/js/custom.js"></script>
    <script src="assets/js/jquery.sPage.js"></script>
    <script src="assets/js/commont.js"></script>
    <script type="text/javascript">
        // 初始化
        function init() {
            $('#activeName').val('');
            $('#returnRate').val('');
            $('#peopleWonPrizePerDay').val('');
            $('#freeTimes').val('');
            $('#isPromote').val('0');
            $('#pattern').val('0');
        }
        init();
        var posterUrl = '';

        var serverIp_ = localStorage.getItem('serverIp');
        var token = localStorage.getItem('token');
        var agencyId = localStorage.getItem('agencyId');

        var urlParamInfo = urlParam();
        var configurationId = urlParamInfo.configurationId;

        /**
         * 添加奖品，先单独上传奖品图片
         * 再添加奖品
         */
        function uploadPrize() {
            let f = document.getElementById('file').files[0];
            // console.log(f);
            let imgSize = f.size;
            if (imgSize > 1024 * 1024 * 10) {
                $('.tipText').text("上传图片不能超过10M");
                $('#wangModal').modal('show');
                return;
            } else {
                let formdata = new FormData();
                if (f != "") {
                    formdata.append('icon', f);
                }
                $.ajax({
                    headers: {
                        "token": token
                    },
                    type: "post",
                    url: serverIp_ + "/agency/good/upload",
                    data: formdata,
                    dataType: "json",
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        if (data.code === 0) {
                            console.log("上传奖品成功");
                            document.getElementById('img3').src = data.data;
                            $("#imgSpan .img2").css("display", "none");
                            $("#img3").css("display", "block");
                        } else {
                            $('.tipText').text(data.message);
                            $('#wangModal').modal('show');
                        }
                    },
                    error: function () {
                        $('#errorTip').text("上传失败！");
                    }
                });
            }
        }

        function submitPrize() {
            var d = {};
            var t = $('#addform').serializeArray();
            var picUrl = $('#img3').attr('src');
            //console.log(picUrl);
            t.push({
                "name": "icon",
                "value": picUrl
            });
            $.each(t, function () {
                d[this.name] = this.value;
            });
            console.log(d);
            for (let key in d) {
                if (key == "icon" && d[key] == '') {
                    $('.tipText').text("请上传奖品图片");
                    $('#wangModal').modal('show');
                    return;
                } else if (key == "prizeName" && d[key] == '') {
                    $('.tipText').text("请输入奖品名称");
                    $('#wangModal').modal('show');
                    return;
                } else if (key == "probability" && d[key] == '') {
                    $('.tipText').text("请输入奖品中奖概率");
                    $('#wangModal').modal('show');
                    return;
                } else if (key == "price" && d[key] == '') {
                    $('.tipText').text("请输入奖品价值");
                    $('#wangModal').modal('show');
                    return;
                } else if (key == "amount" && d[key] == '') {
                    $('.tipText').text("请输入奖品数量");
                    $('#wangModal').modal('show');
                    return;
                } else if (key == "fqMode" && d[key] > 0) {
                    var prizeLink = $('#prizeLink').val();
                    if (prizeLink == '') {
                        $('.tipText').text("奖品链接不能为空");
                        $('#wangModal').modal('show');
                        return;
                    }
                }
            }
            $.ajax({
                headers: {
                    "token": token
                },
                type: "post",
                url: serverIp_ + "/agency/good/add",
                data: JSON.stringify({
                    "businessId": agencyId,
                    "configurationId": configurationId,
                    "name": d.prizeName,
                    "probability": d.probability,
                    "price": d.price,
                    "status": d.amount,
                    "type": d.fqMode,
                    "secretWords": d.prizeLink,
                    "icon": d.icon,
                    "description": d.description,
                    "poster": posterUrl
                }),
                contentType: 'application/json;charset=UTF-8',
                dataType: "json",
                success: function (data) {
                    console.log("奖品保存成功")
                    console.log(data);
                    if (data.code === 0) {
                        window.location.href = "prizeManage.html?configurationId=" + configurationId;
                    } else {
                        $('.tipText').text(data.message);
                        $('#wangModal').modal('show');
                    }
                }
            });
        }

        //上传多个文件方法
        //input file已增加multiple属性，按住ctrl可选择多图
        document.getElementById("add-pic-btn").addEventListener("change", function () {
            var obj = this,
                length = obj.files.length,
                _html = '';
            console.log(obj.files);
            if (length > 5) {
                $('.tipText').text("最多上传5张海报");
                $('#wangModal').modal('show');
            } else if (length > 0) {
                $("#groupTu").empty();
                posterUrl = '';
                for (var i = 0; i < length; i++) {
                    // 上传图片
                    uploadFile(obj.files[i]);
                }
                posterUrl = posterUrl.substring(0, posterUrl.length - 1);
                console.log("posterUrl: " + posterUrl);
            }
        })

        //上传海报到服务器
        function uploadFile(f) {
            let imgSize = f.size;
            if (imgSize > 1024 * 1024 * 10) {
                $('.tipText').text("上传图片不能超过10M");
                $('#wangModal').modal('show');
                return;
            } else {
                let formdata = new FormData();
                console.log(f);
                if (f != "") {
                    formdata.append('file', f);
                }
                $.ajax({
                    headers: {
                        "token": token
                    },
                    type: "post",
                    url: serverIp_ + "/agency/file/upload",
                    async: false, //设置成同步
                    data: formdata,
                    dataType: "text",
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        console.log(data);
                        console.log("上传奖品成功");
                        // 拼接所有海报url
                        posterUrl += data + ',';
                        $("#groupTu").append(`
                            <div class="item">
                                <div class="pic-box">
                                    <img src="${data}" alt="poster" class="img">
                                </div>
                            </div>
                        `);
                    },
                    error: function () {
                        console.log("失败");
                    }
                });
            }
        }

        // 模态框居中
        ModalDialog('wangModal');

        //返回
        $(".back").click(function () {
            window.location.href = "prizeManage.html?configurationId=" + configurationId;
        })
    </script>
</body>

</html>